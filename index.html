<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legal Intake Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- **NEW**: Add jsPDF library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // --- Icon Components ---
        const ClockIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-orange-500"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>);
        const CheckCircleIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-green-500"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>);
        const LinkIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-500"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>);
        const TimerIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-teal-500"><line x1="10" y1="2" x2="14" y2="2"></line><line x1="12" y1="14" x2="12" y2="22"></line><circle cx="12" cy="8" r="6"></circle></svg>);
        const ChevronDownIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-gray-500"><polyline points="6 9 12 15 18 9"></polyline></svg>);
        const XIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>);

        // --- Reusable Components ---

        const DashboardHeader = () => {
          const [buttonText, setButtonText] = useState('+ Create Intake Link');
          const [isCopied, setIsCopied] = useState(false);

          const handleCreateLinkClick = () => {
            const intakeLink = `https://caseintakechatbot.netlify.app`; // Example URL
            
            navigator.clipboard.writeText(intakeLink).then(() => {
              setButtonText('Copied!');
              setIsCopied(true);
              setTimeout(() => { setButtonText('+ Create Intake Link'); setIsCopied(false); }, 2000);
            }).catch(err => console.error('Failed to copy text: ', err));
          };

          return (
            <header className="flex justify-between items-center p-6 bg-white border-b border-gray-200">
              <div>
                <h1 className="text-2xl font-bold text-gray-800">LegalIntake Dashboard</h1>
                <p className="text-sm text-gray-500">Manage client intake assessments</p>
              </div>
              <div className="flex items-center gap-4">
                <button onClick={handleCreateLinkClick} className={`px-4 py-2 font-semibold rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition-all duration-200 ${isCopied ? 'bg-green-500 text-white focus:ring-green-500' : 'bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500'}`}>{buttonText}</button>
                <div className="flex items-center gap-3"><div className="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-white font-bold text-lg">SJ</div><div><p className="font-semibold text-gray-800">Sarah Johnson</p><p className="text-xs text-gray-500">Attorney</p></div></div>
              </div>
            </header>
          );
        };

        const StatCard = ({ title, value, trend, trendColor, icon, footerText }) => (
          <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200 flex flex-col justify-between">
            <div className="flex justify-between items-start"><h3 className="text-sm font-medium text-gray-500">{title}</h3>{icon}</div>
            <div className="mt-2"><p className="text-3xl font-bold text-gray-800">{value}</p>{trend && <p className={`text-xs font-semibold mt-1 ${trendColor}`}>{trend}</p>}</div>
            {footerText && <p className="text-xs text-gray-400 mt-4">{footerText}</p>}
          </div>
        );

        // --- **FIXED & IMPROVED** Modal Component for Viewing Reports ---
        const ReportModal = ({ report, analysis, onClose, isLoading }) => {
            if (!report) return null;

            // This new function is much smarter at parsing markdown-like text into clean HTML.
            const renderFormattedText = (text) => {
                if (!text) return null;
                const lines = text.split('\n').filter(line => line.trim() !== '');
                const elements = [];
                let currentList = [];

                const flushList = () => {
                    if (currentList.length > 0) {
                        elements.push(<ul key={`ul-${elements.length}`} className="list-disc list-inside space-y-1 my-2 pl-4">{currentList}</ul>);
                        currentList = [];
                    }
                };

                const renderInlineFormatting = (line) => {
                    return line.split(/(\*\*.*?\*\*)/g).map((part, i) => {
                        if (part.startsWith('**') && part.endsWith('**')) {
                            return <strong key={i} className="font-semibold text-gray-900">{part.slice(2, -2)}</strong>;
                        }
                        return part;
                    });
                };

                lines.forEach((line, index) => {
                    const trimmedLine = line.trim();
                    if ((trimmedLine.startsWith('**') && trimmedLine.endsWith('**')) || trimmedLine.startsWith('###')) {
                        flushList();
                        const headingText = trimmedLine.replace(/^###\s*/, '').replace(/\*\*/g, '');
                        elements.push(<h4 key={index} className="font-bold text-gray-800 mt-4 mb-2">{headingText}</h4>);
                    } else if (trimmedLine.startsWith('*')) {
                        currentList.push(<li key={index}>{renderInlineFormatting(trimmedLine.replace(/^\*\s*/, ''))}</li>);
                    } else if (trimmedLine.length > 0) {
                        flushList();
                        elements.push(<p key={index} className="my-2">{renderInlineFormatting(trimmedLine)}</p>);
                    }
                });

                flushList(); // Add any remaining list items at the end
                return elements;
            };

            // --- **FIXED & IMPROVED** PDF Generation Function ---
            const handleDownloadPDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ unit: 'pt', format: 'a4' });
                let y = 40;
                const leftMargin = 40;
                const rightMargin = 40;
                const pageWidth = doc.internal.pageSize.getWidth();
                const usableWidth = pageWidth - leftMargin - rightMargin;

                const addText = (text, options = {}) => {
                    const { size = 10, isBold = false, spaceAfter = 10, font = 'helvetica' } = options;
                    if (y > doc.internal.pageSize.getHeight() - 40) { doc.addPage(); y = 40; }
                    doc.setFont(font, isBold ? "bold" : "normal");
                    doc.setFontSize(size);
                    const textLines = doc.splitTextToSize(text, usableWidth);
                    doc.text(textLines, leftMargin, y);
                    y += (textLines.length * size * 1.15) + spaceAfter;
                };

                const addBulletedText = (text) => {
                    const bullet = "\u2022";
                    const textLines = doc.splitTextToSize(text, usableWidth - 15);
                    if (y > doc.internal.pageSize.getHeight() - 40) { doc.addPage(); y = 40; }
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "normal");
                    doc.text(`${bullet} ${textLines[0]}`, leftMargin + 5, y);
                    if (textLines.length > 1) {
                        doc.text(textLines.slice(1), leftMargin + 15, y + 10);
                    }
                    y += (textLines.length * 10) + 4;
                };

                // --- PDF Content ---
                addText(`Case Analysis Report: ${report.caseNumber}`, { size: 18, isBold: true, spaceAfter: 20 });
                
                addText("Client Details", { size: 14, isBold: true, spaceAfter: 5 });
                addText(`Name: ${report.clientName}`);
                addText(`Email: ${report.clientEmail}`);
                addText(`Phone: ${report.clientPhone}`);
                y += 10;

                addText("AI-Powered Analysis", { size: 14, isBold: true, spaceAfter: 5 });
                analysis.split('\n').forEach(line => {
                    const trimmedLine = line.trim();
                    if ((trimmedLine.startsWith('**') && trimmedLine.endsWith('**')) || trimmedLine.startsWith('###')) {
                        addText(trimmedLine.replace(/^###\s*/, '').replace(/\*\*/g, ''), { isBold: true, size: 11, spaceAfter: 5 });
                    } else if (trimmedLine.startsWith('*')) {
                        addBulletedText(trimmedLine.slice(1).trim());
                    } else if (trimmedLine.length > 0) {
                        addText(trimmedLine, { size: 10, spaceAfter: 8 });
                    }
                });
                y += 10;

                addText("Full Intake Report", { size: 14, isBold: true, spaceAfter: 5 });
                addText(report.reportContent, { size: 9, font: 'courier' });
                
                doc.save(`Case-Report-${report.caseNumber}.pdf`);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                        <div className="flex justify-between items-center p-4 border-b">
                            <h2 className="text-xl font-semibold text-gray-800">Case Analysis: {report.caseNumber}</h2>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-800"><XIcon /></button>
                        </div>
                        <div className="p-6 overflow-y-auto">
                            <h3 className="text-lg font-bold text-gray-800 mb-2">Client Details</h3>
                            <p className="text-sm text-gray-600"><strong>Name:</strong> {report.clientName}</p>
                            <p className="text-sm text-gray-600"><strong>Email:</strong> {report.clientEmail}</p>
                            <p className="text-sm text-gray-600"><strong>Phone:</strong> {report.clientPhone}</p>
                            <hr className="my-6" />
                            <h3 className="text-lg font-bold text-gray-800 mb-2">AI-Powered Analysis</h3>
                            {isLoading ? (<div className="text-center p-8"><p className="text-gray-600">Generating analysis...</p></div>) : (<div className="prose prose-sm max-w-none text-gray-700">{renderFormattedText(analysis)}</div>)}
                            <hr className="my-6" />
                            <h3 className="text-lg font-bold text-gray-800 mb-2">Full Intake Report</h3>
                            <pre className="bg-gray-50 p-4 rounded-md text-xs text-gray-700 whitespace-pre-wrap font-mono">{report.reportContent}</pre>
                        </div>
                        <div className="p-4 border-t bg-gray-50 rounded-b-lg flex justify-between">
                            <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300">Close</button>
                            <button onClick={handleDownloadPDF} className="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700">Download as PDF</button>
                        </div>
                    </div>
                </div>
            );
        };

        function App() {
          const [reports, setReports] = useState([]);
          const [loading, setLoading] = useState(true);
          const [selectedReport, setSelectedReport] = useState(null);
          const [analysis, setAnalysis] = useState('');
          const [isAnalysisLoading, setIsAnalysisLoading] = useState(false);

          const backendUrl = 'https://caseintake.onrender.com';

          const fetchReports = useCallback(async () => {
            setLoading(true);
            try {
                const response = await fetch(`${backendUrl}/api/reports`);
                const data = await response.json();
                setReports(data);
            } catch (error) {
                console.error("Failed to fetch reports:", error);
            } finally {
                setLoading(false);
            }
          }, []);

          useEffect(() => { fetchReports(); }, [fetchReports]);

          const handleViewReport = async (report) => {
            setSelectedReport(report);
            setIsAnalysisLoading(true);
            setAnalysis('');

            const analysisPrompt = `
                You are a senior partner in a law firm reviewing a case intake report. 
                Your task is to provide a high-level analysis for the handling attorney.
                Based on the report below, you MUST provide the following three sections. 
                Use this exact formatting: use ** for bold headings (e.g., "**Case Strength:**") and * for bullet points (e.g., "* Item 1"). 
                Do not use any other markdown like '###' or numbered lists.
                
                1. **Case Strength:** A percentage estimate and a brief, one-sentence justification.
                2. **Recommendations:** A bulleted list of 3-4 immediate, actionable next steps.
                3. **Required Documents:** A checklist of documents to request from the client.

                Here is the intake report:
                ---
                ${report.reportContent}
                ---
            `;
            
            try {
                const response = await fetch(`${backendUrl}/api/gemini`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: analysisPrompt })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || "Failed to generate analysis");
                setAnalysis(data.candidates[0].content.parts[0].text.trim());
            } catch (error) {
                setAnalysis(`Failed to generate analysis: ${error.message}`);
            } finally {
                setIsAnalysisLoading(false);
            }
          };

          const handleDeleteReport = async (reportId) => {
            if (window.confirm("Are you sure you want to delete this case report? This action cannot be undone.")) {
                try {
                    await fetch(`${backendUrl}/api/reports/${reportId}`, { method: 'DELETE' });
                    fetchReports();
                } catch (error) {
                    console.error("Failed to delete report:", error);
                }
            }
          };

          const pendingReviews = reports.length;
          const completedThisWeek = reports.filter(r => new Date(r.createdAt._seconds * 1000) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)).length;

          return (
            <div className="bg-gray-50 min-h-screen">
              <DashboardHeader />
              <main className="p-6">
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                  <StatCard title="Pending Reviews" value={pendingReviews} icon={<ClockIcon />} />
                  <StatCard title="Completed This Week" value={completedThisWeek} icon={<CheckCircleIcon />} />
                  <StatCard title="Active Links" value="0" footerText="Feature coming soon" icon={<LinkIcon />} />
                  <StatCard title="Avg. Completion Time" value="12m" trend="-2m improvement" trendColor="text-green-600" icon={<TimerIcon />} />
                </div>
                
                <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mt-8">
                  <div className="flex justify-between items-center mb-4">
                    <h2 className="text-lg font-semibold text-gray-800">Recent Case Assessments</h2>
                    <div className="flex gap-4">
                      <button className="flex items-center gap-2 text-sm font-medium text-gray-700 bg-gray-50 border border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-100">All Practice Areas <ChevronDownIcon /></button>
                      <button className="flex items-center gap-2 text-sm font-medium text-gray-700 bg-gray-50 border border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-100">All Statuses <ChevronDownIcon /></button>
                    </div>
                  </div>
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left text-gray-600">
                      <thead className="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                          <th scope="col" className="px-6 py-3">Case #</th>
                          <th scope="col" className="px-6 py-3">Client</th>
                          <th scope="col" className="px-6 py-3">Email</th>
                          <th scope="col" className="px-6 py-3">Completed</th>
                          <th scope="col" className="px-6 py-3">Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        {loading ? (
                            <tr><td colSpan="5" className="text-center p-8">Loading reports...</td></tr>
                        ) : reports.map((report) => (
                          <tr key={report.id} className="bg-white border-b hover:bg-gray-50">
                            <td className="px-6 py-4 font-mono text-xs text-gray-500">{report.caseNumber}</td>
                            <td className="px-6 py-4 font-medium text-gray-900">{report.clientName}</td>
                            <td className="px-6 py-4">{report.clientEmail}</td>
                            <td className="px-6 py-4">{new Date(report.createdAt._seconds * 1000).toLocaleDateString()}</td>
                            <td className="px-6 py-4 flex items-center gap-4">
                              <button onClick={() => handleViewReport(report)} className="font-medium text-blue-600 hover:underline">View Report</button>
                              <button onClick={() => handleDeleteReport(report.id)} className="font-medium text-red-600 hover:underline">Delete</button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              </main>
              {selectedReport && <ReportModal report={selectedReport} analysis={analysis} isLoading={isAnalysisLoading} onClose={() => setSelectedReport(null)} />}
            </div>
          );
        }

        const container = document.getElementById('root');
        if (!container._reactRootContainer) {
            const root = ReactDOM.createRoot(container);
            root.render(<App />);
        }
    </script>
</body>
</html>
