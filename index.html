<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legal Intake Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // --- Icon Components ---
        const ClockIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-orange-500"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>);
        const CheckCircleIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-green-500"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>);
        const LinkIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-500"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>);
        const TimerIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-teal-500"><line x1="10" y1="2" x2="14" y2="2"></line><line x1="12" y1="14" x2="12" y2="22"></line><circle cx="12" cy="8" r="6"></circle></svg>);
        const XIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>);
        
        const AnalysisLoadingAnimation = () => (
            <div className="flex flex-col items-center justify-center p-8 text-center">
                <div className="relative w-20 h-20">
                    <svg className="absolute inset-0 w-full h-full text-blue-500 animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <svg className="absolute inset-0 w-full h-full p-3 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2C9.243 2 7 4.243 7 7v3.5c0 .276-.224-.5-.5-.5S6 10.776 6 10.5V7c0-3.309 2.691-6 6-6s6 2.691 6 6v3.5c0 .276-.224.5-.5.5s-.5-.224-.5-.5V7c0-2.757-2.243-5-5-5zM9 14c-1.103 0-2 .897-2 2v2c0 1.103.897 2 2 2h6c1.103 0 2-.897 2-2v-2c0-1.103-.897-2-2-2H9z"></path>
                    </svg>
                </div>
                <p className="mt-4 text-lg font-semibold text-gray-700">Generating AI Analysis & Report...</p>
                <p className="text-sm text-gray-500">This may take a moment.</p>
            </div>
        );

        const DashboardHeader = ({ onInternalInfoClick, onHowToUseClick, onCreateIntakeLink }) => {
         return (
            <header className="flex justify-between items-center p-6 bg-white border-b border-gray-200">
              <div>
                <h1 className="text-2xl font-bold text-gray-800">LegalIntake Dashboard</h1>
                <p className="text-sm text-gray-500">Manage client intake assessments</p>
                <div className="flex gap-4">
                    <button onClick={onInternalInfoClick} className="text-xs text-blue-600 hover:underline mt-1">Internal Info</button>
                    <button onClick={onHowToUseClick} className="text-xs text-green-600 hover:underline mt-1">How to use the APP</button>
                </div>
              </div>
              <div className="flex items-center gap-4">
                <button onClick={onCreateIntakeLink} className="px-4 py-2 font-semibold rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition-all duration-200 bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500">
                  + Create Intake Link
                </button>
                <div className="flex items-center gap-3"><div className="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-white font-bold text-lg">SJ</div><div><p className="font-semibold text-gray-800">Sarah Johnson</p><p className="text-xs text-gray-500">Attorney</p></div></div>
              </div>
            </header>
          );
        };

        const StatCard = ({ title, value, trend, trendColor, icon, footerText }) => (
          <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200 flex flex-col justify-between">
            <div className="flex justify-between items-start"><h3 className="text-sm font-medium text-gray-500">{title}</h3>{icon}</div>
            <div className="mt-2"><p className="text-3xl font-bold text-gray-800">{value}</p>{trend && <p className={`text-xs font-semibold mt-1 ${trendColor}`}>{trend}</p>}</div>
            {footerText && <p className="text-xs text-gray-400 mt-4">{footerText}</p>}
          </div>
        );

        const StrengthGauge = ({ percentage }) => {
            const sqSize = 100;
            const strokeWidth = 10;
            const radius = (sqSize - strokeWidth) / 2;
            const viewBox = `0 0 ${sqSize} ${sqSize}`;
            const dashArray = radius * Math.PI * 2;
            const dashOffset = dashArray - dashArray * percentage / 100;
            let color = '#22c55e';
            if (percentage < 40) color = '#ef4444';
            else if (percentage < 70) color = '#f59e0b';
            return (
                <svg width={sqSize} height={sqSize} viewBox={viewBox}>
                    <circle className="fill-none stroke-gray-200" cx={sqSize / 2} cy={sqSize / 2} r={radius} strokeWidth={`${strokeWidth}px`} />
                    <circle className="fill-none transition-all duration-700" stroke={color} cx={sqSize / 2} cy={sqSize / 2} r={radius} strokeLinecap="round" strokeWidth={`${strokeWidth}px`} transform={`rotate(-90 ${sqSize / 2} ${sqSize / 2})`} style={{ strokeDasharray: dashArray, strokeDashoffset: dashOffset }} />
                    <text className="text-xl font-bold" fill={color} x="50%" y="50%" dy=".3em" textAnchor="middle">{`${percentage}%`}</text>
                </svg>
            );
        };

        const ReportModal = ({ report, analysis, formattedReport, onClose, isLoading }) => {
            if (!report) return null;
            
            const renderFormattedText = (text) => {
                if (!text) return null;
                const strengthRegex = /\*\*Case Strength:\*\*\s*(\d+)%\s*-\s*(.*)/;
                const strengthMatch = text.match(strengthRegex);
                const elements = [];
                let currentList = [];
                const flushList = () => {
                    if (currentList.length > 0) {
                        elements.push(<ul key={`ul-${elements.length}`} className="list-disc list-inside space-y-1 my-2 pl-4">{currentList}</ul>);
                        currentList = [];
                    }
                };
                const lines = text.split('\n').filter(line => line.trim() !== '' && !line.match(strengthRegex));
                if (strengthMatch) {
                    const percentage = parseInt(strengthMatch[1], 10);
                    const justification = strengthMatch[2];
                    elements.push(
                        <div key="strength-gauge" className="mb-4">
                            <h4 className="font-bold text-gray-800 mt-4 mb-2">Case Strength</h4>
                            <div className="flex items-center gap-4 p-4 bg-gray-50 rounded-lg">
                                <StrengthGauge percentage={percentage} />
                                <p className="text-gray-700 flex-1">{justification}</p>
                            </div>
                        </div>
                    );
                }
                lines.forEach((line, index) => {
                    const trimmedLine = line.trim();
                    if ((trimmedLine.startsWith('**') && trimmedLine.endsWith('**')) || trimmedLine.startsWith('###')) {
                        flushList();
                        const headingText = trimmedLine.replace(/^###\s*/, '').replace(/\*\*/g, '');
                        elements.push(<h4 key={index} className="font-bold text-gray-800 mt-4 mb-2">{headingText}</h4>);
                    } else if (trimmedLine.startsWith('*')) {
                        currentList.push(<li key={index}>{trimmedLine.replace(/^\*\s*/, '')}</li>);
                    } else if (trimmedLine.length > 0) {
                        flushList();
                        elements.push(<p key={index} className="my-2">{trimmedLine}</p>);
                    }
                });
                flushList();
                return elements;
            };
            
            const renderFullReport = (text) => {
                if (!text) return <p>Formatting report...</p>;
                const lines = text.split('\n');
                return lines.map((line, index) => {
                    const trimmedLine = line.trim();
                    if (trimmedLine === '***') return <hr key={index} className="my-4 border-gray-300" />;
                    if (trimmedLine.startsWith('###') || (trimmedLine.startsWith('**') && trimmedLine.endsWith(':**'))) {
                        return <h4 key={index} className="font-semibold text-gray-900 mt-5 mb-2">{trimmedLine.replace(/###\s*/, '').replace(/\*\*/g, '')}</h4>;
                    }
                    if (trimmedLine.startsWith('**') && trimmedLine.endsWith('**')) {
                        return <h3 key={index} className="font-bold text-lg text-center text-gray-800 my-4">{trimmedLine.slice(2, -2)}</h3>;
                    }
                    if (trimmedLine.startsWith('* ')) return <p key={index} className="my-1 ml-4">{`• ${trimmedLine.slice(2)}`}</p>;
                    if (trimmedLine.length > 0) return <p key={index} className="my-2">{trimmedLine}</p>;
                    return null;
                });
            };

            const handleDownloadPDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ unit: 'pt', format: 'a4' });
                const pageHeight = doc.internal.pageSize.getHeight();
                const topMargin = 40; const bottomMargin = 40; const leftMargin = 40; const rightMargin = 40;
                const usableWidth = doc.internal.pageSize.getWidth() - leftMargin - rightMargin;
                let y = topMargin;

                const checkPageBreak = (heightNeeded) => { if (y + heightNeeded > pageHeight - bottomMargin) { doc.addPage(); y = topMargin; } };
                
                const addText = (text, options = {}) => {
                    const { size = 10, isBold = false, spaceAfter = 10, font = 'helvetica', isListItem = false, isCentered = false } = options;
                    doc.setFont(font, isBold ? "bold" : "normal");
                    doc.setFontSize(size);
                    const lineHeight = size * 1.2;
                    const splitWidth = usableWidth - (isListItem ? 15 : 0);
                    const textLines = doc.splitTextToSize(text, splitWidth);
                    checkPageBreak(textLines.length * lineHeight + spaceAfter);
                    textLines.forEach((line, index) => {
                        let lineX = leftMargin;
                        if(isCentered) { const textWidth = doc.getStringUnitWidth(line) * doc.internal.getFontSize() / doc.internal.scaleFactor; lineX = (doc.internal.pageSize.getWidth() - textWidth) / 2; }
                        else if (isListItem) { if (index === 0) doc.text('\u2022', leftMargin, y); lineX = leftMargin + 15; }
                        doc.text(line, lineX, y);
                        y += lineHeight;
                    });
                    y += spaceAfter;
                };

                addText(`Case Analysis Report: ${report.caseNumber}`, { size: 18, isBold: true, spaceAfter: 20, isCentered: true });
                
                addText("Client Details", { size: 14, isBold: true, spaceAfter: 5 });
                addText(`Name: ${report.clientName}`);
                addText(`Email: ${report.clientEmail}`);
                addText(`Phone: ${report.clientPhone || 'N/A'}`, { spaceAfter: 20 });

                addText("AI-Powered Analysis", { size: 14, isBold: true, spaceAfter: 10 });
                analysis.split('\n').forEach(line => {
                    const trimmedLine = line.trim();
                    if (!trimmedLine) return;
                    if ((trimmedLine.startsWith('**') && trimmedLine.endsWith('**')) || trimmedLine.startsWith('###')) { addText(trimmedLine.replace(/^###\s*/, '').replace(/\*\*/g, ''), { isBold: true, size: 11, spaceAfter: 5 }); }
                    else if (trimmedLine.startsWith('*')) { addText(trimmedLine.slice(1).trim(), { isListItem: true, spaceAfter: 2 }); }
                    else { addText(trimmedLine, { size: 10, spaceAfter: 8 }); }
                });
                y += 10;

                addText("Full Intake Report", { size: 14, isBold: true, spaceAfter: 10 });
                (formattedReport || '').split('\n').forEach(line => {
                    const trimmedLine = line.trim();
                    if (trimmedLine === '***') { y+= 5; doc.setDrawColor(200); doc.line(leftMargin, y, doc.internal.pageSize.getWidth() - rightMargin, y); y += 15; }
                    else if (trimmedLine.startsWith('###') || (trimmedLine.startsWith('**') && trimmedLine.endsWith(':**'))) { 
                        addText(trimmedLine.replace(/###\s*/, '').replace(/\*\*/g, ''), { size: 12, isBold: true, spaceAfter: 5 }); 
                    }
                    else if (trimmedLine.startsWith('**') && trimmedLine.endsWith('**') && !trimmedLine.includes(':')) { 
                        addText(trimmedLine.slice(2, -2), { size: 14, isBold: true, isCentered: true, spaceAfter: 15 }); 
                    }
                    else if (trimmedLine.startsWith('* ')) { 
                        addText(trimmedLine.substring(2), { isListItem: true, spaceAfter: 2 }); 
                    }
                    else if (trimmedLine.length > 0) { 
                        addText(trimmedLine, { spaceAfter: 8 }); 
                    }
                });

                doc.save(`Case-Report-${report.caseNumber}.pdf`);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                        <div className="flex justify-between items-center p-4 border-b"><h2 className="text-xl font-semibold text-gray-800">Case Analysis: {report.caseNumber}</h2><button onClick={onClose} className="text-gray-500 hover:text-gray-800"><XIcon /></button></div>
                        <div className="p-6 overflow-y-auto">
                            <h3 className="text-lg font-bold text-gray-800 mb-2">Client Details</h3>
                            <p className="text-sm text-gray-600"><strong>Name:</strong> {report.clientName}</p>
                            <p className="text-sm text-gray-600"><strong>Email:</strong> {report.clientEmail}</p>
                            <p className="text-sm text-gray-600"><strong>Phone:</strong> {report.clientPhone}</p>
                            <hr className="my-6" />
                            <h3 className="text-lg font-bold text-gray-800 mb-2">AI-Powered Analysis</h3>
                            {isLoading ? <AnalysisLoadingAnimation /> : <div className="prose prose-sm max-w-none text-gray-700">{renderFormattedText(analysis)}</div>}
                            <hr className="my-6" />
                            <h3 className="text-lg font-bold text-gray-800 mb-2">Full Intake Report</h3>
                            <div className="bg-gray-50 p-4 rounded-md text-sm">
                                {isLoading ? <p>Formatting report...</p> : renderFullReport(formattedReport)}
                            </div>
                        </div>
                        <div className="p-4 border-t bg-gray-50 rounded-b-lg flex justify-between">
                            <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300">Close</button>
                            <button onClick={handleDownloadPDF} disabled={isLoading} className="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 disabled:bg-green-300">Download as PDF</button>
                        </div>
                    </div>
                </div>
            );
        };

        const LoginModal = ({ onGo, onClose }) => {
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const handleGoClick = async () => {
                setIsLoading(true);
                setError('');
                const success = await onGo(password);
                setIsLoading(false);
                if (!success) {
                    setError('Incorrect password. Please try again.');
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50">
                    <div className="bg-white rounded-lg shadow-2xl p-8 w-full max-w-sm text-center">
                        <h2 className="text-xl font-bold text-gray-800 mb-2">Developer Access</h2>
                        <p className="text-gray-600 mb-6">This section is only for developers.</p>
                        <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleGoClick()} className={`w-full px-4 py-2 border rounded-lg mb-2 ${error ? 'border-red-500' : 'border-gray-300'}`} placeholder="Enter access code" />
                        {error && <p className="text-red-500 text-sm mb-2">{error}</p>}
                        <button onClick={handleGoClick} disabled={isLoading} className="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors disabled:bg-blue-300">
                            {isLoading ? 'Verifying...' : 'GO'}
                        </button>
                        <button onClick={onClose} className="text-xs text-gray-500 hover:underline mt-4">Cancel</button>
                    </div>
                </div>
            );
        };
        
        const DeleteConfirmationModal = ({ onConfirm, onCancel }) => (
            <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50">
                <div className="bg-white rounded-lg shadow-2xl p-8 w-full max-w-sm text-center">
                    <h2 className="text-xl font-bold text-gray-800 mb-2">Are you sure?</h2>
                    <p className="text-gray-600 mb-6">This action cannot be undone. The report will be permanently deleted.</p>
                    <div className="flex justify-center gap-4">
                        <button onClick={onCancel} className="px-6 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300">Cancel</button>
                        <button onClick={onConfirm} className="px-6 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700">Delete</button>
                    </div>
                </div>
            </div>
        );
        
        const CredentialsModal = ({ caseId, passcode, onClose }) => {
            const [copyText, setCopyText] = useState('Copy Link');
            const chatbotUrl = `https://caseintake-chat-bot.netlify.app/?caseId=${caseId}&passcode=${passcode}`;

            const handleCopy = () => {
                const textArea = document.createElement("textarea");
                textArea.value = chatbotUrl;
                textArea.style.position = "fixed";
                textArea.style.top = 0;
                textArea.style.left = 0;
                textArea.style.opacity = 0;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    setCopyText('Copied!');
                } catch (err) {
                    setCopyText('Failed!');
                }
                document.body.removeChild(textArea);
                setTimeout(() => setCopyText('Copy Link'), 2000);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-md">
                        <div className="flex justify-between items-center p-4 border-b">
                            <h2 className="text-xl font-semibold text-gray-800">Intake Link Created</h2>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-800"><XIcon /></button>
                        </div>
                        <div className="p-6 space-y-4">
                            <p className="text-gray-600">Share the following credentials with your client. The link is single-use and will expire after the intake is completed.</p>
                            <div>
                                <label className="text-sm font-bold text-gray-700">Case ID</label>
                                <p className="font-mono bg-gray-100 p-2 rounded mt-1">{caseId}</p>
                            </div>
                            <div>
                                <label className="text-sm font-bold text-gray-700">Passcode</label>
                                <p className="font-mono bg-gray-100 p-2 rounded mt-1">{passcode}</p>
                            </div>
                            <div>
                                <label className="text-sm font-bold text-gray-700">Client Link</label>
                                <div className="flex gap-2 mt-1">
                                    <input type="text" readOnly value={chatbotUrl} className="w-full p-2 border rounded-md bg-gray-100 font-mono text-sm" />
                                    <button onClick={handleCopy} className="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 whitespace-nowrap">{copyText}</button>
                                </div>
                            </div>
                        </div>
                        <div className="p-4 border-t bg-gray-50 rounded-b-lg flex justify-end">
                            <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300">Close</button>
                        </div>
                    </div>
                </div>
            );
        };

        const InternalInfoModal = ({ onClose }) => {
            const resources = {
                "GitHub Repositories": [
                    { name: "Backend (caseintake) on Render.com" },
                    { name: "Dashboard (caseintakefrontend)", subtext: "Host in Netlify with name newcase" },
                    { name: "Chatbot (caseintakechatbot)", subtext: "Host in Netlify with name caseintake-chat-bot" }
                ],
                "Live Deployments": [
                    { name: "Dashboard (newcase) on Netlify.com" },
                    { name: "Chatbot (caseintake-chat-bot) on Netlify.com" },
                    { name: "Backend API (Render)" }
                ],
                "Database": [
                    { name: "Firebase Database for the cases and case Reports under the Project (Gemini API)" }
                ]
            };
            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
                         <div className="flex justify-between items-center p-4 border-b">
                            <h2 className="text-xl font-semibold text-gray-800">Internal Project Resources</h2>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-800"><XIcon /></button>
                        </div>
                        <div className="p-6 overflow-y-auto space-y-6">
                            {Object.entries(resources).map(([category, items]) => (
                                <div key={category}>
                                    <h3 className="text-lg font-bold text-gray-800 mb-3 border-b pb-2">{category}</h3>
                                    <ul className="space-y-2 list-inside">
                                        {items.map(item => (
                                            <li key={item.name} className="text-gray-800">
                                                <span className="font-medium">{item.name}</span>
                                                {item.subtext && <p className="text-sm text-gray-500 pl-4">{item.subtext}</p>}
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                            ))}
                        </div>
                         <div className="p-4 border-t bg-gray-50 rounded-b-lg flex justify-end">
                            <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300">Close</button>
                        </div>
                    </div>
                </div>
            );
        };

        const HowToUseModal = ({ onClose }) => {
            const GuideStep = ({ title, imageSrc, children }) => (
                <div className="mb-8">
                    <h3 className="text-xl font-bold text-gray-800 mb-3">{title}</h3>
                    <div className="text-gray-700 space-y-2 mb-4">{children}</div>
                    <img src={imageSrc} alt={title} className="rounded-lg border border-gray-300 shadow-md" />
                </div>
            );

            return (
                 <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col">
                         <div className="flex justify-between items-center p-4 border-b">
                            <h2 className="text-2xl font-semibold text-gray-800">How to Use the Dashboard</h2>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-800"><XIcon /></button>
                        </div>
                        <div className="p-6 overflow-y-auto">
                            <GuideStep title="1. Create an Intake Link" imageSrc="https://i.postimg.cc/NjnFZBfL/Ceate-Intake-Link.jpg">
                                <p>Click the <strong>+ Create Intake Link</strong> button to copy the link for the client-facing chatbot. You can then send this link to your clients to start the intake process.</p>
                            </GuideStep>
                             <GuideStep title="2. Dashboard Overview" imageSrc="https://i.postimg.cc/mkcBYFCw/Dashboard-over-vew-boxes.jpg">
                                <p>The boxes at the top give you a quick summary of your workload, including how many reports are pending review and how many have been completed this week.</p>
                            </GuideStep>
                             <GuideStep title="3. Recent Case Assessments" imageSrc="https://i.postimg.cc/VsHjzQ6Q/recent-case-assesements.jpg">
                                <p>This table lists all the intake reports submitted by your clients. You can see the case number, client name, and other details at a glance. Click <strong>View Report</strong> to see the full details or <strong>Delete</strong> to remove a report.</p>
                            </GuideStep>
                             <GuideStep title="4. Generating the AI Analysis" imageSrc="https://i.postimg.cc/P58WJ673/generatinf-ai-analysis.jpg">
                                <p>When you view a report, the system automatically starts generating a high-level AI analysis. This animation indicates that the AI is processing the information.</p>
                            </GuideStep>
                             <GuideStep title="5. Understanding the Report" imageSrc="https://i.postimg.cc/SNLY954j/Understanding-the-Report.jpg">
                                <p>The AI-Powered Analysis section provides a visual <strong>Case Strength</strong> gauge, a summary, and actionable recommendations. Below this, you can find the complete, formatted transcript of the client's intake interview.</p>
                                <p>Finally, you can click the <strong>Download as PDF</strong> button to save a clean, professional copy of the entire report for your records.</p>
                            </GuideStep>
                        </div>
                         <div className="p-4 border-t bg-gray-50 rounded-b-lg flex justify-end">
                            <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300">Close</button>
                        </div>
                    </div>
                </div>
            );
        };


        function App() {
          const [reports, setReports] = useState([]);
          const [loading, setLoading] = useState(true);
          const [selectedReport, setSelectedReport] = useState(null);
          const [analysis, setAnalysis] = useState('');
          const [formattedReport, setFormattedReport] = useState('');
          const [isAnalysisLoading, setIsAnalysisLoading] = useState(false);
          const [showLoginModal, setShowLoginModal] = useState(false);
          const [showInternalInfoModal, setShowInternalInfoModal] = useState(false);
          const [showHowToUseModal, setShowHowToUseModal] = useState(false);
          const [reportToDelete, setReportToDelete] = useState(null);
          const [generatedCredentials, setGeneratedCredentials] = useState(null);

          const backendUrl = 'https://caseintake.onrender.com';

          const fetchReports = useCallback(async () => {
            setLoading(true);
            try {
                const response = await fetch(`${backendUrl}/api/reports`);
                const data = await response.json();
                setReports(data);
            } catch (error) { console.error("Failed to fetch reports:", error); }
            finally { setLoading(false); }
          }, []);

          useEffect(() => { fetchReports(); }, [fetchReports]);

          const handleViewReport = async (report) => {
            setSelectedReport(report);
            setIsAnalysisLoading(true);
            setAnalysis('');
            setFormattedReport('');

            try {
                const analysisPrompt = `
                    You are a senior partner in a law firm reviewing a case intake report. 
                    Your task is to provide a high-level analysis for the handling attorney.
                    Based on the report below, you MUST provide the following three sections. 
                    Use this exact formatting: use ** for bold headings (e.g., "**Case Strength:**") and * for bullet points (e.g., "* Item 1"). 
                    
                    1. **Case Strength:** A percentage estimate followed by a hyphen and a brief, one-sentence justification (e.g., "**Case Strength:** 75% - The client has strong evidence.").
                    2. **Recommendations:** A bulleted list of 3-4 immediate, actionable next steps.
                    3. **Required Documents:** A checklist of documents to request from the client.

                    Here is the intake report:
                    ---
                    ${report.reportContent}
                    ---
                `;
                const analysisResponse = await fetch(`${backendUrl}/api/gemini`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: analysisPrompt })
                });
                const analysisData = await analysisResponse.json();
                if (!analysisResponse.ok) throw new Error(analysisData.error || "Failed to generate analysis");
                setAnalysis(analysisData.candidates[0].content.parts[0].text.trim());

                let formattedDateTime = 'Date not available';
                if (report.createdAt && (typeof report.createdAt.seconds === 'number' || typeof report.createdAt._seconds === 'number')) {
                    const seconds = report.createdAt.seconds || report.createdAt._seconds;
                    const reportDate = new Date(seconds * 1000);
                    formattedDateTime = reportDate.toLocaleString(undefined, {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        timeZoneName: 'short'
                    });
                }

                const formatResponse = await fetch(`${backendUrl}/api/format-report`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        reportData: report.reportContent,
                        formattedDateTime: formattedDateTime
                    })
                });
                const formatData = await formatResponse.json();
                if (!formatResponse.ok) throw new Error(formatData.error || "Failed to format report");
                setFormattedReport(formatData.formattedReport);

            } catch (error) { 
                setAnalysis(`Analysis Error: ${error.message}`);
                setFormattedReport(`Report Formatting Error: ${error.message}`);
            }
            finally { setIsAnalysisLoading(false); }
          };

          const handleDeleteReport = (reportId) => {
            setReportToDelete(reportId);
          };
          
          const executeDelete = async () => {
              if (!reportToDelete) return;
              try {
                  await fetch(`${backendUrl}/api/reports/${reportToDelete}`, { method: 'DELETE' });
                  setReportToDelete(null); 
                  fetchReports(); 
              } catch (error) {
                  console.error("Failed to delete report:", error);
                  setReportToDelete(null);
              }
          };
          
          const handleCreateIntakeLink = async () => {
              try {
                  const response = await fetch(`${backendUrl}/api/create-intake-credentials`, { method: 'POST' });
                  const data = await response.json();
                  if (data.success) {
                      setGeneratedCredentials({ caseId: data.caseId, passcode: data.passcode });
                  } else {
                      console.error("Failed to create credentials:", data.error);
                  }
              } catch (error) {
                  console.error("Error calling create credentials endpoint:", error);
              }
          };

          const handleLoginSubmit = async (password) => {
            try {
                const response = await fetch(`${backendUrl}/api/internal-login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: password })
                });
                const data = await response.json();
                if (data.success) {
                    setShowInternalInfoModal(true);
                    setShowLoginModal(false);
                    return true;
                } else {
                    return false;
                }
            } catch (error) {
                console.error("Login error:", error);
                return false;
            }
          };

          const pendingReviews = reports.length;
          const completedThisWeek = reports.filter(r => {
              if (!r.createdAt || (typeof r.createdAt.seconds !== 'number' && typeof r.createdAt._seconds !== 'number')) return false;
              const seconds = r.createdAt.seconds || r.createdAt._seconds;
              return new Date(seconds * 1000) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
          }).length;

          return (
            <div className="bg-gray-50 min-h-screen">
              <DashboardHeader 
                onInternalInfoClick={() => setShowLoginModal(true)} 
                onHowToUseClick={() => setShowHowToUseModal(true)}
                onCreateIntakeLink={handleCreateIntakeLink}
              />
              <main className="p-6">
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                  <StatCard title="Pending Reviews" value={pendingReviews} icon={<ClockIcon />} />
                  <StatCard title="Completed This Week" value={completedThisWeek} icon={<CheckCircleIcon />} />
                  <StatCard title="Active Links" value="0" footerText="Feature coming soon" icon={<LinkIcon />} />
                  <StatCard title="Avg. Completion Time" value="12m" trend="-2m improvement" trendColor="text-green-600" icon={<TimerIcon />} />
                </div>
                <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mt-8">
                  <div className="mb-4">
                    <h2 className="text-lg font-semibold text-gray-800">Recent Case Assessments</h2>
                  </div>
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left text-gray-600">
                      <thead className="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                          <th scope="col" className="px-6 py-3">Case #</th>
                          <th scope="col" className="px-6 py-3">Client</th>
                          <th scope="col" className="px-6 py-3">Email</th>
                          <th scope="col" className="px-6 py-3">Completed</th>
                          <th scope="col" className="px-6 py-3">Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        {loading ? (<tr><td colSpan="5" className="text-center p-8">Loading reports...</td></tr>) : reports.map((report) => (
                          <tr key={report.id} className="bg-white border-b hover:bg-gray-50">
                            <td className="px-6 py-4 font-mono text-xs text-gray-500">{report.caseNumber}</td>
                            <td className="px-6 py-4 font-medium text-gray-900">{report.clientName}</td>
                            <td className="px-6 py-4">{report.clientEmail}</td>
                            <td className="px-6 py-4">
                                {report.createdAt && (report.createdAt.seconds || report.createdAt._seconds)
                                    ? new Date((report.createdAt.seconds || report.createdAt._seconds) * 1000).toLocaleDateString()
                                    : 'N/A'
                                }
                            </td>
                            <td className="px-6 py-4 flex items-center gap-4">
                              <button onClick={() => handleViewReport(report)} className="font-medium text-blue-600 hover:underline">View Report</button>
                              <button onClick={() => handleDeleteReport(report.id)} className="font-medium text-red-600 hover:underline">Delete</button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              </main>
              {selectedReport && <ReportModal report={selectedReport} analysis={analysis} formattedReport={formattedReport} isLoading={isAnalysisLoading} onClose={() => setSelectedReport(null)} />}
              
              {reportToDelete && <DeleteConfirmationModal onConfirm={executeDelete} onCancel={() => setReportToDelete(null)} />}
              
              {generatedCredentials && <CredentialsModal caseId={generatedCredentials.caseId} passcode={generatedCredentials.passcode} onClose={() => setGeneratedCredentials(null)} />}

              {showLoginModal && <LoginModal onGo={handleLoginSubmit} onClose={() => setShowLoginModal(false)} />}
              {showInternalInfoModal && <InternalInfoModal onClose={() => setShowInternalInfoModal(false)} />}
              {/* **FIX**: Corrected the onClose handler to close the modal. */}
              {showHowToUseModal && <HowToUseModal onClose={() => setShowHowToUseModal(false)} />}
            </div>
          );
        }
        const container = document.getElementById('root');
        if (!container._reactRootContainer) {
            const root = ReactDOM.createRoot(container);
            root.render(<App />);
        }
    </script>
</body>
</html>
